<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="styles2/main.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-logo">
            <a href="#">MyApp</a>
        </div>
        <div class="nav-links">
            <span>Welcome, <span id="username">User</span></span>

            <!-- Search bar -->
            <input type="text" id="search-bar" placeholder="Search location...">
            <select id="distance-dropdown">
                <option value="2">2 miles</option>
                <option value="5">5 miles</option>
                <option value="10">10 miles</option>
                <option value="20">20 miles</option>
            </select>
            <button onclick="filterParking()">Search</button>
            <a href="logout.html" class="logout-btn">Logout</a>
        </div>
    </nav>

    <!-- Profile Info -->
    <div id="profile">
        <h2 id="profileUsername">Username</h2>
        <p id="userLocation">Bronx, NY</p>
    </div>

    <!-- Parking Results Container -->
    <div id="parking-results" class="parking-results"></div>

    <script>
        // Retrieve the user data from localStorage
        const userData = JSON.parse(localStorage.getItem('userData'));

        // Check if user data exists and update the profile page accordingly
        if (userData && userData.username) {
            document.getElementById('username').textContent = userData.username;
            document.getElementById('profileUsername').textContent = userData.username;

            if (userData.location) {
                document.getElementById('userLocation').textContent = userData.location;
            }
        } else {
            document.getElementById('username').textContent = 'User';
            document.getElementById('profileUsername').textContent = 'Username';
            document.getElementById('userLocation').textContent = 'Unknown location';
        }
    </script>

    <script>
        const apiKey = 'AIzaSyDaFXlaMKGJPNDUme7clG5_7JRqthjsZe8';

        // Fixed location for Bronk (use actual coordinates for Bronk if available)
        const bronkCoordinates = { lat: 42.730, lng: -73.690 };

        // Helper function to calculate distance in miles
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Radius of Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Function to show the top 5 closest parking spots
        function showTop5Parking() {
            fetch('../csvjson.json')
                .then(response => response.json())
                .then(parkingData => {
                    // Filter and sort parking spots by distance from Bronk
                    const sortedParking = parkingData
                        .filter(parkingLot => parkingLot.Latitude && parkingLot.Longitude)
                        .map(parkingLot => {
                            // Ensure we're using numbers for latitude and longitude
                            const lat = parseFloat(parkingLot.Latitude);
                            const lon = parseFloat(parkingLot.Longitude);
                            if (!isNaN(lat) && !isNaN(lon)) {
                                parkingLot.distance = getDistance(
                                    bronkCoordinates.lat, bronkCoordinates.lng, lat, lon
                                );
                            } else {
                                parkingLot.distance = Infinity; // Invalid coordinates result in very large distance
                            }
                            return parkingLot;
                        })
                        .sort((a, b) => a.distance - b.distance) // Sort by distance (ascending)
                        .slice(0, 5); // Limit to top 5 closest

                    displayParking(sortedParking);
                })
                .catch(error => {
                    console.error("Error fetching parking data:", error);
                });
        }

        // Function to display parking spots with map views
        function displayParking(parkingSpots) {
            const parkingResults = document.getElementById('parking-results');
            parkingResults.innerHTML = ''; // Clear previous results

            parkingSpots.forEach(parkingLot => {
                const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${parkingLot.Latitude},${parkingLot.Longitude}&zoom=15&size=300x300&markers=color:red%7Clabel:%7C${parkingLot.Latitude},${parkingLot.Longitude}&key=${apiKey}`;

                const parkingDiv = document.createElement('div');
                parkingDiv.classList.add('parking-spot'); // Add container styling class
                parkingDiv.innerHTML = `
                    <div class="parking-info">
                        <img src="${mapUrl}" alt="${parkingLot["Business Name"]}" class="map-image">
                        <h3>${parkingLot["Business Name"]}</h3>
                        <p><strong>Address:</strong> ${parkingLot["Building Number"]} ${parkingLot["Street1"]}, ${parkingLot["City"]}, ${parkingLot["State"]} ${parkingLot["ZIP Code"]}</p>
                        <p><strong>Details:</strong> ${parkingLot["Details"]}</p>
                        <p><strong>Distance:</strong> ${parkingLot.distance.toFixed(2)} miles</p>
                    </div>
                `;
                parkingResults.appendChild(parkingDiv);
            });
        }

        // Automatically call showTop5Parking when the page loads
        document.addEventListener('DOMContentLoaded', showTop5Parking);
    </script>

    <script>

        // Helper function to calculate distance in miles
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Radius of Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Function to fetch coordinates of address
        function getCoordinates(address) {
            const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;
            return fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        const location = data.results[0].geometry.location;
                        return { lat: location.lat, lng: location.lng };
                    } else {
                        alert("Unable to find location.");
                        return null;
                    }
                })
                .catch(error => {
                    console.error("Error fetching coordinates:", error);
                    alert("Error fetching coordinates.");
                    return null;
                });
        }

        // Fetch and filter parking data
        function filterParking() {
            const address = document.getElementById("search-bar").value;
            const distance = parseInt(document.getElementById("distance-dropdown").value);

            if (!address) {
                alert("Please enter an address.");
                return;
            }

            getCoordinates(address).then(coordinates => {
                if (coordinates) {
                    fetch('../csvjson.json')
                        .then(response => response.json())
                        .then(parkingData => {
                            // Filter and sort the parking spots based on distance
                            const filteredParking = parkingData
                                .filter(parkingLot => {
                                    const { Latitude, Longitude } = parkingLot;
                                    if (Latitude && Longitude) {
                                        const dist = getDistance(coordinates.lat, coordinates.lng, parseFloat(Latitude), parseFloat(Longitude));
                                        parkingLot.distance = dist; // Attach distance for sorting
                                        return dist <= distance;
                                    }
                                    return false;
                                })
                                .sort((a, b) => a.distance - b.distance); // Sort by distance

                            displayParking(filteredParking, coordinates);
                        })
                        .catch(error => {
                            console.error("Error fetching parking data:", error);
                        });
                }
            });
        }

        // Function to display filtered parking spots with map views
        function displayParking(parkingSpots, userCoordinates) {
            const parkingResults = document.getElementById('parking-results');
            parkingResults.innerHTML = ''; // Clear previous results

            parkingSpots.forEach(parkingLot => {
                const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${parkingLot.Latitude},${parkingLot.Longitude}&zoom=15&size=300x300&markers=color:red%7Clabel:%7C${parkingLot.Latitude},${parkingLot.Longitude}&key=${apiKey}`;

                const parkingDiv = document.createElement('div');
                parkingDiv.classList.add('parking-spot'); // Add container styling class
                parkingDiv.innerHTML = `
                    <div class="parking-info">
                        <img src="${mapUrl}" alt="${parkingLot["Business Name"]}" class="map-image">
                        <h3>${parkingLot["Business Name"]}</h3>
                        <p><strong>Address:</strong> ${parkingLot["Building Number"]} ${parkingLot["Street1"]}, ${parkingLot["City"]}, ${parkingLot["State"]} ${parkingLot["ZIP Code"]}</p>
                        <p><strong>Details:</strong> ${parkingLot["Details"]}</p>
                        <p><strong>Distance:</strong> ${parkingLot.distance.toFixed(2)} miles</p>
                    </div>
                `;
                parkingResults.appendChild(parkingDiv);
            });
        }
    </script>
</body>
</html>
